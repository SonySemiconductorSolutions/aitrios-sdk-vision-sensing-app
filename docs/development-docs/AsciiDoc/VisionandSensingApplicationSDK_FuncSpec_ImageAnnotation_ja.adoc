= pass:[<br/>]Vision and Sensing Application SDK 画像アノテーション 機能仕様書
:toc:
:toclevels: 1
:toc-title: Table of Contents（目次）

== 更新履歴

|===
|Date |What/Why

|2022/11/10
|初版作成
|===

== 用語・略語
|===
|Terms/Abbreviations |Meaning 

|tag/タグ
|正解ラベル

|annotation/アノテーション
|ラベルなどの情報、ラベリング

|データセット
|学習やモデルの評価を行うための画像とアノテーションのデータの集合体

|COCO形式
|<<coco,COCOのデータフォーマット>>
|===

== 参照資料

* Reference/Related documents（関連資料）
** [[vott]]VoTT
*** https://github.com/microsoft/VoTT
** [[coco]]COCO data format
*** https://cocodataset.org/#format-data
** [[portforward]]Codespaces port forwarding
*** https://docs.github.com/en/codespaces/codespaces-reference/security-in-codespaces#port-forwarding

== 想定ユースケース
* データセット作成
** Object Detectionタスク
*** ユーザーが持つ自前の画像データに対し、アノテーションを行いたい
*** データセットにデータを追加したりタグを編集するなど、カスタマイズを行いたい

== 機能概要、アルゴリズム
=== Functional Overview
* SDKのDev Container(Local PCまたはCodespaces)において、デスクトップ版VoTTが起動できる +
* VoTTの機能でデータのアノテーション追加や編集、マニュアルでのアノテーションを実現できる
* Local file systemやCodespacesからVoTTへの画像データのインポートができる
** インポートが可能な画像の格納先は下記表の通り
*** SDKでは「Local file system」をサポートする

|===
|VoTTがサポートするインポートが可能な画像の格納先 |SDKにおけるサポート

|https://docs.microsoft.com/en-us/azure/storage/blobs/storage-blobs-introduction[Azure Blob Storage]
|No

|https://www.microsoft.com/en-us/bing/apis/bing-image-search-api[Bing画像検索]
|No

|Local file system
|Yes

|===

* VoTTからLocal file systemやCodespacesへのアノテーションファイルのエクスポートができる
** エクスポートフォーマットは下記表の通り
*** SDKでは「VoTT (generic JSON schema)」のみサポートする

|===
|VoTTがサポートするエクスポートフォーマット |SDKにおけるサポート

|https://azure.microsoft.com/en-us/services/cognitive-services/custom-vision-service/[Azure Custom Vision Service]
|No

|https://github.com/Microsoft/CNTK[Microsoft Cognitive Toolkit (CNTK)]
|No

|TensorFlow (Pascal VOC and TFRecords)
|No

|VoTT (generic JSON schema)
|Yes

|Comma Separated Values (CSV)
|No

|===

* VoTTからエクスポートしたアノテーションファイルをVoTT形式からCOCO形式に変換できる

== シーケンス
ここでは本機能の処理の流れを説明する。

. Dev Container上にある画像データをVoTTにインポートする
. VoTTでアノテーションを行う
. VoTTにおいてエクスポートを実施すると、アノテーションファイルがDev Container上のファイルシステムに格納される
. Dev Container上で、VoTTからエクスポートされたVoTT形式のアノテーションファイルをCOCO形式に変換を行う

Dev Container上にある画像データをインポートする場合

[mermaid]
----
sequenceDiagram
    Dev Container->>VoTT: 1.画像データのインポート
    VoTT->>VoTT: 2.アノテーション
    VoTT-->>Dev Container: 3.アノテーションファイルのエクスポート
    Dev Container->>Dev Container: 4.COCO形式への変換
----

== 操作性仕様、画面仕様

NOTE: 本仕様書では、SDKが提供するDev Containerに組み込まれたVoTTの操作性仕様を記述する。VoTTを単独で動かす場合の動作については対象外である。

=== How to start each function
. SDK環境を立ち上げ、Topの `**README.md**` をプレビュー表示する
. SDK環境Topの `**README.md**` に含まれるハイパーリンクから、 `**tutorials**` ディレクトリの `**README.md**` にジャンプする
. `**tutorials**` ディレクトリの `**README.md**` に含まれるハイパーリンクから、prepare datasetディレクトリにジャンプする
. prepare datasetディレクトリの `**README.md**` に含まれるハイパーリンクから、annotate imagesディレクトリにジャンプする
. annotate imagesディレクトリの各ファイルから各機能に遷移する

=== デスクトップ版VoTTの起動
. Dev Container起動後に、VS Code UIの「Port」タブから「Port6080」をブラウザで開く
** 起動完了すると、noVNC接続画面が表示される
. noVNCの接続画面から、VoTTの使用方法を記載した<<novncpassword,Notebookに記載しているパスワード>>を入力する
** 認証に成功すると、デスクトップに接続される
. 接続したデスクトップ画面でターミナルを開き、VoTT起動コマンドを実行する
** コマンド実行後、デスクトップ版VoTTが起動する

「1.」、「2.」について下記参照。 +
Fluxboxを使用してDevelopment ContainerのGUI環境を作成。noVNCを使用してブラウザからコンテナにアクセスする。noVNCにはポートフォワードで接続する。 +

NOTE: Codespacesで動作させる場合（Browser）では、 <<limitation,noVNC接続が数分で切断される現象>> あり。

=== 画像データのVoTTへのインポート
* Dev Containerから画像をインポートする場合
. VoTTの「Connection Settings」機能から「Local file system」を選択する
. Dev Container上の、画像を格納したフォルダを設定する +
. インポートを実行する
** インポート手順は <<vott,VoTTのドキュメント>> 参照

NOTE: 画像データのインポートはVoTTの機能で実現する。したがってインポート機能自体は本SDKの範囲外である。


=== VoTT上でのアノテーション
. VoTT上でアノテーションを実行する
** アノテーション手順は <<vott,VoTTのドキュメント>> 参照

NOTE: アノテーションはVoTTの機能で実現する。したがってアノテーション機能自体は本SDKの範囲外である。


=== VoTTからアノテーションファイルのエクスポート
. VoTTの「Connection Settings」機能から「Local file system」を選択する
. 画像を保存するDev Container上のフォルダを設定する +
. エクスポートを実行する

NOTE: アノテーションファイルのエクスポートはVoTTの機能で実現する。したがってエクスポート機能自体は本SDKの範囲外である。

=== アノテーションファイルのVoTT形式からCOCO形式への変換
* 前提条件
. 事前にVoTTでアノテーションを行い、VoTT形式でのエクスポートを行っておく
** VoTT形式でエクスポートするための設定は下記：
*** VoTTのプロジェクトを開き、「Export Settings」の「Provider」で「VoTT JSON」形式を選択

* 変換
. VoTT形式をCOCO形式に変換するNotebookを実行する
. Notebookを実行して出力されるドロップダウンリストから、インプットとなるVoTT形式のアノテーションファイルを選択する
. Notebookを実行して出力されるテキストボックスに、アウトプットとなるCOCO形式のアノテーションファイルを格納するフォルダパス、ファイル名を入力する
** ファイルの格納先となる、Dev Containerのフォルダを設定する
. 1.に引き続き、VoTT形式をCOCO形式に変換するNotebookを実行する
** 設定した格納先にCOCO形式のアノテーションファイルが格納される

== 目標性能
* ユーザビリティ
** SDKの環境構築完了後、追加のインストール手順なしに、VoTTを使用できること
*** ただし、VoTTの初回起動時は、VoTTのビルドを実施するため起動に実績として1分程度かかる
*** 実績は下記条件にて計測

|===
|項目 |内容

|CPU
|Intel® Core™ i7-8665U CPU @ 1.90GHz 2.11 GHz

|RAM
|16.0 GB

|OS
|Windows 10 バージョン 21H2

|WSL2
|Ubuntu-20.04
|===


== 制限事項
* CodespacesのMachine Typeが最小構成(2-core)だとVoTTのDesktop版が起動失敗するため、4-core以上のMachine Typeを選択する必要がある
* [[limitation]]CodespacesでnoVNC接続が数分で切断される場合がある
** Codespacesから https://docs.github.com/en/enterprise-cloud@latest/codespaces/developing-in-codespaces/using-codespaces-in-visual-studio-code[VS Code desktop]を起動するとこの現象を回避できる

== その他特記事項
* SDK内で定義するエラーコード、メッセージはなし
* [[novncpassword]]noVNCパスワードをドキュメントに記載することについて
** Codespacesの<<portforward,port forward>>がデフォルトでprivate設定になっており、コンテナの作成者以外がそのポートにアクセスできないようになっているため、セキュリティ上の問題はなし

== 未決定事項
なし